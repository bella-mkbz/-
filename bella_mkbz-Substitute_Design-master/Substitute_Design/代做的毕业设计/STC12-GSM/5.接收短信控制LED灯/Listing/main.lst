C51 COMPILER V9.60.0.0   MAIN                                                              02/11/2020 19:23:41 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN ..\Output\main.obj
COMPILER INVOKED BY: D:\software install\Keil_C51\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRI
                    -NT(..\Listing\main.lst) TABS(2) OBJECT(..\Output\main.obj)

line level    source

   1          /**********************************************************************************
   2           * ¹¤³ÌÃû  :
   3           * ÃèÊö    :Í¨¹ýÊÖ»ú·¢ËÍ¶ÌÐÅ¿ØÖÆLED
   4           * ÊµÑéÆ½Ì¨:STC12XX
   5           * ¿â°æ±¾  :
   6           * ×÷Õß    :ÄàÈËÍ¨ÐÅÄ£¿é¿ª·¢Æ½Ì¨ÍÅ¶Ó 
   7           * ²©¿Í    :http://nirenelec.blog.163.com
   8           * ÌÔ±¦    :http://shop105683814.taobao.com
   9          **********************************************************************************/
  10          
  11          #include "string.h"
  12          #include "delay.h"
*** ERROR C103 IN LINE 52 OF STC12C5Axx.H: '<string>': unclosed string
*** ERROR C129 IN LINE 52 OF STC12C5Axx.H: missing ';' before '<string>'
*** ERROR C305 IN LINE 52 OF STC12C5Axx.H: unterminated string/char const
  13          #include "uart.h"
  14          #include "temp.h"
              
              #define Buf1_Max 60             //´®¿Ú1»º´æ³¤¶È
              #define Buf2_Max 200            //´®¿Ú2»º´æ³¤¶È
              /*************  ±¾µØ³£Á¿ÉùÃ÷  **************/
              sbit Delay_1        = P2^0;         //¼ÌµçÆ÷1
              sbit Delay_2        = P2^1;         //¼ÌµçÆ÷1
              
              /*************  ±¾µØ±äÁ¿ÉùÃ÷  **************/
              xdata u8 Uart1_Buf[Buf1_Max];
              xdata u8 Uart2_Buf[Buf2_Max];
              unsigned char Password[5] = "0806";
              xdata unsigned char phone[14 ] = "\"18539863403\"";
              static unsigned char *content = "Temperature: ";
              static unsigned char *SMS_Num="\"+8613010761500\"";
              u8 Times=0,First_Int = 0,shijian=0;
              //u8 Time_count=0;
              bdata u8 Flag;//¶¨Ê±Æ÷±êÖ¾Î»
              sbit Timer0_start =Flag^0;  //¶¨Ê±Æ÷0ÑÓÊ±Æô¶¯¼ÆÊýÆ÷
              sbit Uart2_Start  =Flag^1;  //´®¿Ú2¿ªÊ¼½ÓÊÕÊý¾Ý
              sbit Uart2_End    =Flag^2;  //´®¿Ú2½ÓÊÕÊý¾Ý½áÊø
              
              
              /*************  ±¾µØº¯ÊýÉùÃ÷  **************/
              void GPIO_config(void);
              void Timer0Init(void);
              void CLR_Buf2(void);
              u8 Find(u8 *a);
              void Set_Text_Mode(void);
              void Check_New_Message(void);
              void Wait_CREG(void);
              void Sec_AT_Command(u8 *b,u8 *a,u8 wait_time);
              void Send_Text_Sms(void);
              void Temp_Change(int temp,unsigned char* Buff);
              /*************  Íâ²¿º¯ÊýºÍ±äÁ¿ÉùÃ÷*****************/
              
              
              /*******************************************************************************
C51 COMPILER V9.60.0.0   MAIN                                                              02/11/2020 19:23:41 PAGE 2   

              * º¯ÊýÃû : main 
              * ÃèÊö   : Ö÷º¯Êý
              * ÊäÈë   : 
              * Êä³ö   : 
              * ·µ»Ø   : 
              * ×¢Òâ   : ´®¿Ú2¸ºÔðÓëGPRSÄ£¿éÍ¨ÐÅ£¬´®¿Ú1ÓÃÓÚ´®¿Úµ÷ÊÔ£¬¿ÉÒÔ±ÜÃâÔÚÏÂÔØ³ÌÐòÊ±Êý¾Ý
                         »¹·¢ËÍµ½Ä£¿é
              *******************************************************************************/
              void main(void)
              {
                GPIO_config();
                Uart1Init();
                Uart2Init();
                Timer0Init();
                EA=1; //¿ª×ÜÖÐ¶Ï
                UART1_SendString("GPRSÄ£¿é¶ÌÐÅ²âÊÔ³ÌÐò\r\n");
                UART1_SendString("GPRSÄ£¿éÔÚ×¢²áÍøÂç\r\n");
                Wait_CREG();
                UART1_SendString("GPRSÄ£¿é×¢²á³É¹¦\r\n");
                UART1_SendString("GPRSÄ£¿é¶ÌÐÅÄ£Ê½ÉèÖÃ\r\n");
                Set_Text_Mode();
                UART1_SendString("ÉèÖÃ³É¹¦£¬¶ÌÐÅÄ£Ê½£ºTEXT\r\n");
                
                UART1_SendString("³õÊ¼»¯Íê³É\r\n");
                
                
                while(1)
                {
                  Check_New_Message();
                  Ds18b20ReadTemp();
                }
                
              }
              
              /*******************************************************************************
              * º¯ÊýÃû : Uart1 
              * ÃèÊö   : ´®¿Ú1ÖÐ¶Ï·þÎñÈë¿Úº¯Êý
              * ÊäÈë   : 
              * Êä³ö   : 
              * ·µ»Ø   : 
              * ×¢Òâ   : 
              *******************************************************************************/
              void Uart1() interrupt 4
              {
                  if (RI)
                  {
                      RI = 0;                 //Çå³ýRIÎ»
                  }
                  if (TI)
                  {
                      TI = 0;                 //Çå³ýTIÎ»
                  }
              }
              
              /*******************************************************************************
              * º¯ÊýÃû : Uart2
              * ÃèÊö   : ´®¿Ú2ÖÐ¶Ï·þÎñÈë¿Úº¯Êý
              * ÊäÈë   : 
              * Êä³ö   : 
              * ·µ»Ø   : 
              * ×¢Òâ   : 
              *******************************************************************************/
C51 COMPILER V9.60.0.0   MAIN                                                              02/11/2020 19:23:41 PAGE 3   

              void Uart2() interrupt 8
              {
                  IE2  &= ~0x01;   //¹Ø±Õ´®¿Ú2ÖÐ¶Ï
                  if (S2CON & S2RI)
                  {
                    S2CON &= ~S2RI;         //Çå³ýS2RIÎ»
                    Uart2_Buf[First_Int] = S2BUF;     //½«½ÓÊÕµ½µÄ×Ö·û´®´æµ½»º´æÖÐ
                    First_Int++;                      //»º´æÖ¸ÕëÏòºóÒÆ¶¯
                    if(First_Int > Buf2_Max)          //Èç¹û»º´æÂú,½«»º´æÖ¸ÕëÖ¸Ïò»º´æµÄÊ×µØÖ·
                    {
                      First_Int = 0;
                    }
                  }
                  if (S2CON & S2TI)
                  {
                    S2CON &= ~S2TI;         //Çå³ýS2TIÎ»
                  }
                  IE2  |= 0x01;   //Ê¹ÄÜ´®¿Ú2ÖÐ¶Ï
              }
              /*******************************************************************************
              * º¯ÊýÃû : Timer0_ISR
              * ÃèÊö   : ¶¨Ê±Æ÷0ÖÐ¶Ï·þÎñÈë¿Úº¯Êý,20msÖÐ¶ÏÒ»´Î
              * ÊäÈë   : 
              * Êä³ö   : 
              * ·µ»Ø   : 
              * ×¢Òâ   : 
              *******************************************************************************/
              void Timer0_ISR() interrupt 1
              {
                TR0=0;//¹Ø¶¨Ê±Æ÷
                if(Timer0_start)
                Times++;
                if(Times > (50*shijian))
                {
                  Timer0_start = 0;
                  Times = 0;
                }
                TR0=1;//¿ª¶¨Ê±Æ÷
              }
              /*******************************************************************************
              * º¯ÊýÃû : GPIO_config
              * ÃèÊö   : IO¿ÚÅäÖÃº¯Êý
              * ÊäÈë   : 
              * Êä³ö   : 
              * ·µ»Ø   : 
              * ×¢Òâ   : 
              *******************************************************************************/
              void  GPIO_config(void)
              {
                  P3M1 &= 0XC3;  //ÅäÖÃP32~P35ÎªÍÆÍìÊä³ö
                  P3M0 |= ~0XC3;
              }
              void Timer0Init(void)   //20ºÁÃë@22.1184MHz
              {
                AUXR &= 0x7F; //12TÄ£Ê½
                TMOD &= 0xF0; //ÉèÖÃ¶¨Ê±Æ÷Ä£Ê½ 16Î»ÖØÔØ
                TL0 = 0x00;   //Éè¶¨¶¨Ê±Æ÷³õÖµ
                TH0 = 0x70;   //Éè¶¨¶¨Ê±Æ÷³õÖµ
                TF0 = 0;      //Çå³ýTF0±êÖ¾
                TR0 = 1;      //¶¨Ê±Æ÷0¿ªÊ¼¼ÆÊ±
                ET0 = 1;      //Ê¹ÄÜ¶¨Ê±Æ÷0ÖÐ¶Ï
              }
C51 COMPILER V9.60.0.0   MAIN                                                              02/11/2020 19:23:41 PAGE 4   

              /*******************************************************************************
              * º¯ÊýÃû : CLR_Buf2
              * ÃèÊö   : Çå³ý´®¿Ú2»º´æÊý¾Ý
              * ÊäÈë   : 
              * Êä³ö   : 
              * ·µ»Ø   : 
              * ×¢Òâ   : 
              *******************************************************************************/
              void CLR_Buf2(void)
              {
                u16 k;
                for(k=0;k<Buf2_Max;k++)      //½«»º´æÄÚÈÝÇåÁã
                {
                  Uart2_Buf[k] = 0x00;
                }
                  First_Int = 0;              //½ÓÊÕ×Ö·û´®µÄÆðÊ¼´æ´¢Î»ÖÃ
              }
              
              /*******************************************************************************
              * º¯ÊýÃû : Find
              * ÃèÊö   : ÅÐ¶Ï»º´æÖÐÊÇ·ñº¬ÓÐÖ¸¶¨µÄ×Ö·û´®
              * ÊäÈë   : 
              * Êä³ö   : 
              * ·µ»Ø   : unsigned char:1 ÕÒµ½Ö¸¶¨×Ö·û£¬0 Î´ÕÒµ½Ö¸¶¨×Ö·û 
              * ×¢Òâ   : 
              *******************************************************************************/
              
              u8 Find(u8 *a)
              { 
                if(strstr(Uart2_Buf,a)!=NULL)
                    return 1;
                else
                    return 0;
              }
              
              /*******************************************************************************
              * º¯ÊýÃû : Second_AT_Command
              * ÃèÊö   : ·¢ËÍATÖ¸Áîº¯Êý
              * ÊäÈë   : ·¢ËÍÊý¾ÝµÄÖ¸Õë¡¢·¢ËÍµÈ´ýÊ±¼ä(µ¥Î»£ºS)
              * Êä³ö   : 
              * ·µ»Ø   : 
              * ×¢Òâ   : 
              *******************************************************************************/
              
              void Sec_AT_Command(u8 *b,u8 *a,u8 wait_time)         
              {
                u8 i;
                u8 *c;
                c = b;                  
                CLR_Buf2(); 
                i = 0;
                while(i == 0)                    
                {
                  if(!Find(a))          
                  {
                    if(Timer0_start == 0)
                    {
                      b = c;          
                      for (b; *b!='\0';b++)
                      {
                        UART2_SendData(*b);
                      }
C51 COMPILER V9.60.0.0   MAIN                                                              02/11/2020 19:23:41 PAGE 5   

                      UART2_SendLR(); 
                      Times = 0;
                      shijian = wait_time;
                      Timer0_start = 1; 
                     }
                  }
                  else
                  {
                    i = 1;
                    Timer0_start = 0;  
                  }
                }
                CLR_Buf2(); 
              }
              
              /*******************************************************************************
              * º¯ÊýÃû : Set_Text_Mode
              * ÃèÊö   : ÉèÖÃ¶ÌÐÅÎªTEXTÎÄ±¾Ä£Ê½
              * ÊäÈë   : 
              * Êä³ö   : 
              * ·µ»Ø   : 
              * ×¢Òâ   : 
              *******************************************************************************/
              void Set_Text_Mode(void)
              {
              //  unsigned char temp[50]="AT+CSCA=";                  
                Sec_AT_Command("ATE0","OK",3);                          //È¡Ïû»ØÏÔ              
                Sec_AT_Command("AT+CNMI=3,2,0,0,0","OK",3);             //ÐÂ¶ÌÐÅÖ±½ÓÊä³ö            
                Sec_AT_Command("AT+CMGF=1","OK",3);                     //TEXTÄ£Ê½  
                Sec_AT_Command("AT+CPMS=\"SM\",\"SM\",\"SM\"","OK",3);  //ËùÓÐ²Ù×÷¶¼ÔÚSIM¿¨ÖÐ½øÐÐ 
              //  strcat(temp,SMS_Num);
              //  Sec_AT_Command(temp,"OK",3);                            //ÉèÖÃ¶ÌÐÅÖÐÐÄºÅÂë
              }
              
              /*******************************************************************************
              * º¯ÊýÃû : Check_Message_rec
              * ÃèÊö   : ¼ì²éÊÇ·ñÓÐÐÂÐÅÏ¢£¬²¢Ö´ÐÐÐÅÏ¢ÄÚÈÝÖ¸Áî
              * ÊäÈë   : 
              * Êä³ö   : 
              * ·µ»Ø   : 
              * ×¢Òâ   : 
              *******************************************************************************/
              
              void Check_New_Message(void)
              {
                u8 temp=0,i;
                if(strstr(Uart2_Buf,"+CMT")!=NULL)      //Èô»º´æ×Ö·û´®ÖÐº¬ÓÐ"+CMT"¾Í±íÊ¾ÓÐÐÂµÄ¶ÌÐÅ
                {
                  delay_ms(50);//µÈ´ýÊý¾ÝÈ«²¿½ÓÊÕÍê³É
                  UART1_SendString("ÊÕµ½ÐÂ¶ÌÐÅ:\r\n");
                  UART1_SendString(Uart2_Buf);      //°ÑÄ£¿é·µ»ØµÄÐÅÏ¢Ô­ÑùÊä³ö
                  if(strstr(Uart2_Buf,Password)!=NULL)
                  {
                    if(strstr(Uart2_Buf,"Switch1:on")!=NULL)
                    {
                      UART1_SendString("ÊÕµ½ÐÂ¶ÌÐÅ:Switch1:on\r\n");
                      Delay_1 = 0;
                    }
                    if(strstr(Uart2_Buf,"Switch1:off")!=NULL)
                    {
                      UART1_SendString("ÊÕµ½ÐÂ¶ÌÐÅ:Switch1:off\r\n");
                      Delay_1 = 1;
C51 COMPILER V9.60.0.0   MAIN                                                              02/11/2020 19:23:41 PAGE 6   

                    }
                    if(strstr(Uart2_Buf,"Switch2:on")!=NULL)
                    {
                      UART1_SendString("ÊÕµ½ÐÂ¶ÌÐÅ:Switch2:on\r\n");
                      Delay_2 = 0;
                    }
                    if(strstr(Uart2_Buf,"Switch2:off")!=NULL)
                    {
                      UART1_SendString("ÊÕµ½ÐÂ¶ÌÐÅ:Switch2:off\r\n");
                      Delay_2 = 1;
                    }
                          if(strstr(Uart2_Buf,"Check")!=NULL)
                    {
                      UART1_SendString("ÊÕµ½ÐÂ¶ÌÐÅ:Check\r\n");
                      UART1_SendString(&Uart2_Buf[12]);
                      for(i=0;i<11;i++)
                          phone[1+i] = Uart2_Buf[12+i];
                      Send_Text_Sms();
                    }
                    if(strstr(Uart2_Buf,"Alter")!=NULL)
                    {
                      UART1_SendString("ÊÕµ½ÐÂ¶ÌÐÅ:Alter\r\n");
                      UART1_SendString(&Uart2_Buf[First_Int-6]);
                      Password[0] = Uart2_Buf[First_Int-6];
                      Password[1] = Uart2_Buf[First_Int-5];
                      Password[2] = Uart2_Buf[First_Int-4];
                      Password[3] = Uart2_Buf[First_Int-3];
                      UART1_SendString(Password);
                      UART1_SendString("ÐÂÃÜÂë\r\n");
                    }
                  }
                  CLR_Buf2();
                  Sec_AT_Command("AT+CMGD=1,1","OK",3);//É¾³ý¶ÌÐÅ
                }
              }
              
              /*******************************************************************************
              * º¯ÊýÃû : Wait_CREG
              * ÃèÊö   : µÈ´ýÄ£¿é×¢²á³É¹¦
              * ÊäÈë   : 
              * Êä³ö   : 
              * ·µ»Ø   : 
              * ×¢Òâ   : 
              *******************************************************************************/
              void Wait_CREG(void)
              {
                u8 i;
                u8 k;
                i = 0;
                CLR_Buf2();
                while(i == 0)             
                {
                  CLR_Buf2();        
                  UART2_SendString("AT+CREG?");
                  UART2_SendLR();
                  delay_ms(5000);             
                    for(k=0;k<Buf2_Max;k++)           
                    {
                    if(Uart2_Buf[k] == ':')
                    {
                      if((Uart2_Buf[k+4] == '1')||(Uart2_Buf[k+4] == '5'))
                      {
C51 COMPILER V9.60.0.0   MAIN                                                              02/11/2020 19:23:41 PAGE 7   

                        i = 1;
                        UART1_SendLR();
                        break;
                      }
                    }
                  }
                  UART1_SendString("×¢²áÖÐ.....");
                }
              }
              
              void Send_Text_Sms(void)
              {
                unsigned char temp[50]="AT+CMGS=";
                unsigned char Datas_Buff[8]= {0, 0, 0, 0, 0, 0, 0,'\0'};
                Temp_Change(Ds18b20ReadTemp(),Datas_Buff);
                strcat(temp,phone); 
                Sec_AT_Command(temp,">",3); 
                UART2_SendString(content); 
                UART2_SendString(Datas_Buff); 
                UART2_SendData(0X1A); 
                UART2_SendLR(); 
              }
              
              void Temp_Change(int temp,unsigned char* Buff)
              {
                  float tp;  
                  if(temp< 0)       //µ±ÎÂ¶ÈÖµÎª¸ºÊý
                  {
                    Buff[0] = '-';
                  //ÒòÎª¶ÁÈ¡µÄÎÂ¶ÈÊÇÊµ¼ÊÎÂ¶ÈµÄ²¹Âë£¬ËùÒÔ¼õ1£¬ÔÙÈ¡·´Çó³öÔ­Âë
                  temp=temp-1;
                  temp=~temp;
                  tp=temp;
                  temp=tp*0.0625*100+0.5; 
                  //ÁôÁ½¸öÐ¡Êýµã¾Í*100£¬+0.5ÊÇËÄÉáÎåÈë£¬ÒòÎªCÓïÑÔ¸¡µãÊý×ª»»ÎªÕûÐÍµÄÊ±ºò°ÑÐ¡Êýµã
                  //ºóÃæµÄÊý×Ô¶¯È¥µô£¬²»¹ÜÊÇ·ñ´óÓÚ0.5£¬¶ø+0.5Ö®ºó´óÓÚ0.5µÄ¾ÍÊÇ½ø1ÁË£¬Ð¡ÓÚ0.5µÄ¾Í
                  //ËãÓÉÏ0.5£¬»¹ÊÇÔÚÐ¡ÊýµãºóÃæ¡£
                  }
                else
                  { 
                  Buff[0] = '+';      
                  tp=temp;//ÒòÎªÊý¾Ý´¦ÀíÓÐÐ¡ÊýµãËùÒÔ½«ÎÂ¶È¸³¸øÒ»¸ö¸¡µãÐÍ±äÁ¿
                  //Èç¹ûÎÂ¶ÈÊÇÕýµÄÄÇÃ´£¬ÄÇÃ´ÕýÊýµÄÔ­Âë¾ÍÊÇ²¹ÂëËü±¾Éí
                  temp=tp*0.0625*100+0.5; 
                  //ÁôÁ½¸öÐ¡Êýµã¾Í*100£¬+0.5ÊÇËÄÉáÎåÈë£¬ÒòÎªCÓïÑÔ¸¡µãÊý×ª»»ÎªÕûÐÍµÄÊ±ºò°ÑÐ¡Êýµã
                  //ºóÃæµÄÊý×Ô¶¯È¥µô£¬²»¹ÜÊÇ·ñ´óÓÚ0.5£¬¶ø+0.5Ö®ºó´óÓÚ0.5µÄ¾ÍÊÇ½ø1ÁË£¬Ð¡ÓÚ0.5µÄ¾Í
                  //Ëã¼ÓÉÏ0.5£¬»¹ÊÇÔÚÐ¡ÊýµãºóÃæ¡£
                  }
                Buff[1] = temp / 10000 + 0x30;
                Buff[2] = temp % 10000 / 1000 + 0x30;
                Buff[3] = temp % 1000 / 100 + 0x30;
                Buff[4] = '.';  
                Buff[5] = temp % 100 / 10 + 0x30;
                Buff[6] = temp % 10 + 0x30;
              }
              
*** WARNING C316 IN LINE 417 OF main.c: unterminated conditionals

C51 COMPILATION COMPLETE.  1 WARNING(S),  3 ERROR(S)
