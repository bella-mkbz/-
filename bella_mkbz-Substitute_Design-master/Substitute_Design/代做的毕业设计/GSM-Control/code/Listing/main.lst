C51 COMPILER V9.59.0.0   MAIN                                                              12/24/2018 14:09:35 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN ..\Output\main.obj
COMPILER INVOKED BY: D:\keil C51\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(..\Listing\mai
                    -n.lst) TABS(2) OBJECT(..\Output\main.obj)

line level    source

   1          /**********************************************************************************
   2           * ¹¤³ÌÃû  :
   3           * ÃèÊö    :Í¨¹ýÊÖ»ú·¢ËÍ¶ÌÐÅ¿ØÖÆLED
   4           * ÊµÑéÆ½Ì¨:STC12XX
   5           * ¿â°æ±¾  :
   6           * ×÷Õß    :ÄàÈËÍ¨ÐÅÄ£¿é¿ª·¢Æ½Ì¨ÍÅ¶Ó 
   7           * ²©¿Í    :http://nirenelec.blog.163.com
   8           * ÌÔ±¦    :http://shop105683814.taobao.com
   9          **********************************************************************************/
  10          
  11          #include "string.h"
  12          #include "delay.h"
  13          #include "uart.h"
  14          #include "temp.h"
  15          
  16          #define Buf1_Max 60             //´®¿Ú1»º´æ³¤¶È
  17          #define Buf2_Max 200            //´®¿Ú2»º´æ³¤¶È
  18          /*************  ±¾µØ³£Á¿ÉùÃ÷  **************/
  19          sbit Delay_1        = P2^0;         //¼ÌµçÆ÷1
  20          sbit Delay_2        = P2^1;         //¼ÌµçÆ÷1
  21          
  22          /*************  ±¾µØ±äÁ¿ÉùÃ÷  **************/
  23          xdata u8 Uart1_Buf[Buf1_Max];
  24          xdata u8 Uart2_Buf[Buf2_Max];
  25          unsigned char Password[5] = "0806";
  26          xdata unsigned char phone[14 ] = "\"18539863403\"";
  27          static unsigned char *content = "Temperature: ";
  28          static unsigned char *SMS_Num="\"+8613010761500\"";
  29          unsigned char Datas_Buff[8]= {0, 0, 0, 0, 0, 0, 0,'\0'};
  30          u8 Times=0,First_Int = 0,shijian=0;
  31          //u8 Time_count=0;
  32          bdata u8 Flag;//¶¨Ê±Æ÷±êÖ¾Î»
  33          sbit Timer0_start =Flag^0;  //¶¨Ê±Æ÷0ÑÓÊ±Æô¶¯¼ÆÊýÆ÷
  34          sbit Uart2_Start  =Flag^1;  //´®¿Ú2¿ªÊ¼½ÓÊÕÊý¾Ý
  35          sbit Uart2_End    =Flag^2;  //´®¿Ú2½ÓÊÕÊý¾Ý½áÊø
  36          
  37          
  38          /*************  ±¾µØº¯ÊýÉùÃ÷  **************/
  39          void GPIO_config(void);
  40          void Timer0Init(void);
  41          void CLR_Buf2(void);
  42          u8 Find(u8 *a);
  43          void Set_Text_Mode(void);
  44          void Check_New_Message(void);
  45          void Wait_CREG(void);
  46          void Sec_AT_Command(u8 *b,u8 *a,u8 wait_time);
  47          void Send_Text_Sms(void);
  48          void Temp_Change(int temp,unsigned char* Buff);
  49          /*************  Íâ²¿º¯ÊýºÍ±äÁ¿ÉùÃ÷*****************/
  50          
  51          
  52          /*******************************************************************************
  53          * º¯ÊýÃû : main 
  54          * ÃèÊö   : Ö÷º¯Êý
C51 COMPILER V9.59.0.0   MAIN                                                              12/24/2018 14:09:35 PAGE 2   

  55          * ÊäÈë   : 
  56          * Êä³ö   : 
  57          * ·µ»Ø   : 
  58          * ×¢Òâ   : ´®¿Ú2¸ºÔðÓëGPRSÄ£¿éÍ¨ÐÅ£¬´®¿Ú1ÓÃÓÚ´®¿Úµ÷ÊÔ£¬¿ÉÒÔ±ÜÃâÔÚÏÂÔØ³ÌÐòÊ±Êý¾Ý
  59                     »¹·¢ËÍµ½Ä£¿é
  60          *******************************************************************************/
  61          void main(void)
  62          {
  63   1        GPIO_config();
  64   1        Uart1Init();
  65   1        Uart2Init();
  66   1        Timer0Init();
  67   1        EA=1; //¿ª×ÜÖÐ¶Ï
  68   1        UART1_SendString("GPRSÄ£¿é¶ÌÐÅ²âÊÔ³ÌÐò\r\n");
  69   1        UART1_SendString("GPRSÄ£¿éÔÚ×¢²áÍøÂç\r\n");
  70   1        Wait_CREG();
  71   1        UART1_SendString("GPRSÄ£¿é×¢²á³É¹¦\r\n");
  72   1        UART1_SendString("GPRSÄ£¿é¶ÌÐÅÄ£Ê½ÉèÖÃ\r\n");
  73   1        Set_Text_Mode();
  74   1        UART1_SendString("ÉèÖÃ³É¹¦£¬¶ÌÐÅÄ£Ê½£ºTEXT\r\n");
  75   1        
  76   1        UART1_SendString("³õÊ¼»¯Íê³É\r\n");
  77   1        
  78   1        
  79   1        while(1)
  80   1        {
  81   2          Check_New_Message();
  82   2          Ds18b20ReadTemp();
  83   2        }
  84   1        
  85   1      }
  86          
  87          /*******************************************************************************
  88          * º¯ÊýÃû : Uart1 
  89          * ÃèÊö   : ´®¿Ú1ÖÐ¶Ï·þÎñÈë¿Úº¯Êý
  90          * ÊäÈë   : 
  91          * Êä³ö   : 
  92          * ·µ»Ø   : 
  93          * ×¢Òâ   : 
  94          *******************************************************************************/
  95          void Uart1() interrupt 4
  96          {
  97   1          if (RI)
  98   1          {
  99   2              RI = 0;                 //Çå³ýRIÎ»
 100   2          }
 101   1          if (TI)
 102   1          {
 103   2              TI = 0;                 //Çå³ýTIÎ»
 104   2          }
 105   1      }
 106          
 107          /*******************************************************************************
 108          * º¯ÊýÃû : Uart2
 109          * ÃèÊö   : ´®¿Ú2ÖÐ¶Ï·þÎñÈë¿Úº¯Êý
 110          * ÊäÈë   : 
 111          * Êä³ö   : 
 112          * ·µ»Ø   : 
 113          * ×¢Òâ   : 
 114          *******************************************************************************/
 115          void Uart2() interrupt 8
 116          {
C51 COMPILER V9.59.0.0   MAIN                                                              12/24/2018 14:09:35 PAGE 3   

 117   1          IE2  &= ~0x01;   //¹Ø±Õ´®¿Ú2ÖÐ¶Ï
 118   1          if (S2CON & S2RI)
 119   1          {
 120   2            S2CON &= ~S2RI;         //Çå³ýS2RIÎ»
 121   2            Uart2_Buf[First_Int] = S2BUF;     //½«½ÓÊÕµ½µÄ×Ö·û´®´æµ½»º´æÖÐ
 122   2            First_Int++;                      //»º´æÖ¸ÕëÏòºóÒÆ¶¯
 123   2            if(First_Int > Buf2_Max)          //Èç¹û»º´æÂú,½«»º´æÖ¸ÕëÖ¸Ïò»º´æµÄÊ×µØÖ·
 124   2            {
 125   3              First_Int = 0;
 126   3            }
 127   2          }
 128   1          if (S2CON & S2TI)
 129   1          {
 130   2            S2CON &= ~S2TI;         //Çå³ýS2TIÎ»
 131   2          }
 132   1          IE2  |= 0x01;   //Ê¹ÄÜ´®¿Ú2ÖÐ¶Ï
 133   1      }
 134          /*******************************************************************************
 135          * º¯ÊýÃû : Timer0_ISR
 136          * ÃèÊö   : ¶¨Ê±Æ÷0ÖÐ¶Ï·þÎñÈë¿Úº¯Êý,20msÖÐ¶ÏÒ»´Î
 137          * ÊäÈë   : 
 138          * Êä³ö   : 
 139          * ·µ»Ø   : 
 140          * ×¢Òâ   : 
 141          *******************************************************************************/
 142          void Timer0_ISR() interrupt 1
 143          {
 144   1        TR0=0;//¹Ø¶¨Ê±Æ÷
 145   1        if(Timer0_start)
 146   1        Times++;
 147   1        if(Times > (50*shijian))
 148   1        {
 149   2          Timer0_start = 0;
 150   2          Times = 0;
 151   2        }
 152   1        TR0=1;//¿ª¶¨Ê±Æ÷
 153   1      }
 154          /*******************************************************************************
 155          * º¯ÊýÃû : GPIO_config
 156          * ÃèÊö   : IO¿ÚÅäÖÃº¯Êý
 157          * ÊäÈë   : 
 158          * Êä³ö   : 
 159          * ·µ»Ø   : 
 160          * ×¢Òâ   : 
 161          *******************************************************************************/
 162          void  GPIO_config(void)
 163          {
 164   1          P3M1 &= 0XC3;  //ÅäÖÃP32~P35ÎªÍÆÍìÊä³ö
 165   1          P3M0 |= ~0XC3;
 166   1      }
 167          void Timer0Init(void)   //20ºÁÃë@22.1184MHz
 168          {
 169   1        AUXR &= 0x7F; //12TÄ£Ê½
 170   1        TMOD &= 0xF0; //ÉèÖÃ¶¨Ê±Æ÷Ä£Ê½ 16Î»ÖØÔØ
 171   1        TL0 = 0x00;   //Éè¶¨¶¨Ê±Æ÷³õÖµ
 172   1        TH0 = 0x70;   //Éè¶¨¶¨Ê±Æ÷³õÖµ
 173   1        TF0 = 0;      //Çå³ýTF0±êÖ¾
 174   1        TR0 = 1;      //¶¨Ê±Æ÷0¿ªÊ¼¼ÆÊ±
 175   1        ET0 = 1;      //Ê¹ÄÜ¶¨Ê±Æ÷0ÖÐ¶Ï
 176   1      }
 177          /*******************************************************************************
 178          * º¯ÊýÃû : CLR_Buf2
C51 COMPILER V9.59.0.0   MAIN                                                              12/24/2018 14:09:35 PAGE 4   

 179          * ÃèÊö   : Çå³ý´®¿Ú2»º´æÊý¾Ý
 180          * ÊäÈë   : 
 181          * Êä³ö   : 
 182          * ·µ»Ø   : 
 183          * ×¢Òâ   : 
 184          *******************************************************************************/
 185          void CLR_Buf2(void)
 186          {
 187   1        u16 k;
 188   1        for(k=0;k<Buf2_Max;k++)      //½«»º´æÄÚÈÝÇåÁã
 189   1        {
 190   2          Uart2_Buf[k] = 0x00;
 191   2        }
 192   1          First_Int = 0;              //½ÓÊÕ×Ö·û´®µÄÆðÊ¼´æ´¢Î»ÖÃ
 193   1      }
 194          
 195          /*******************************************************************************
 196          * º¯ÊýÃû : Find
 197          * ÃèÊö   : ÅÐ¶Ï»º´æÖÐÊÇ·ñº¬ÓÐÖ¸¶¨µÄ×Ö·û´®
 198          * ÊäÈë   : 
 199          * Êä³ö   : 
 200          * ·µ»Ø   : unsigned char:1 ÕÒµ½Ö¸¶¨×Ö·û£¬0 Î´ÕÒµ½Ö¸¶¨×Ö·û 
 201          * ×¢Òâ   : 
 202          *******************************************************************************/
 203          
 204          u8 Find(u8 *a)
 205          { 
 206   1        if(strstr(Uart2_Buf,a)!=NULL)
 207   1            return 1;
 208   1        else
 209   1            return 0;
 210   1      }
 211          
 212          /*******************************************************************************
 213          * º¯ÊýÃû : Second_AT_Command
 214          * ÃèÊö   : ·¢ËÍATÖ¸Áîº¯Êý
 215          * ÊäÈë   : ·¢ËÍÊý¾ÝµÄÖ¸Õë¡¢·¢ËÍµÈ´ýÊ±¼ä(µ¥Î»£ºS)
 216          * Êä³ö   : 
 217          * ·µ»Ø   : 
 218          * ×¢Òâ   : 
 219          *******************************************************************************/
 220          
 221          void Sec_AT_Command(u8 *b,u8 *a,u8 wait_time)         
 222          {
 223   1        u8 i;
 224   1        u8 *c;
 225   1        c = b;                  
 226   1        CLR_Buf2(); 
 227   1        i = 0;
 228   1        while(i == 0)                    
 229   1        {
 230   2          if(!Find(a))          
 231   2          {
 232   3            if(Timer0_start == 0)
 233   3            {
 234   4              b = c;          
 235   4              for (b; *b!='\0';b++)
 236   4              {
 237   5                UART2_SendData(*b);
 238   5              }
 239   4              UART2_SendLR(); 
 240   4              Times = 0;
C51 COMPILER V9.59.0.0   MAIN                                                              12/24/2018 14:09:35 PAGE 5   

 241   4              shijian = wait_time;
 242   4              Timer0_start = 1; 
 243   4             }
 244   3          }
 245   2          else
 246   2          {
 247   3            i = 1;
 248   3            Timer0_start = 0;  
 249   3          }
 250   2        }
 251   1        CLR_Buf2(); 
 252   1      }
 253          
 254          /*******************************************************************************
 255          * º¯ÊýÃû : Set_Text_Mode
 256          * ÃèÊö   : ÉèÖÃ¶ÌÐÅÎªTEXTÎÄ±¾Ä£Ê½
 257          * ÊäÈë   : 
 258          * Êä³ö   : 
 259          * ·µ»Ø   : 
 260          * ×¢Òâ   : 
 261          *******************************************************************************/
 262          void Set_Text_Mode(void)
 263          {
 264   1      //  unsigned char temp[50]="AT+CSCA=";                  
 265   1        Sec_AT_Command("ATE0","OK",3);                          //È¡Ïû»ØÏÔ              
 266   1        Sec_AT_Command("AT+CNMI=3,2,0,0,0","OK",3);             //ÐÂ¶ÌÐÅÖ±½ÓÊä³ö            
 267   1        Sec_AT_Command("AT+CMGF=1","OK",3);                     //TEXTÄ£Ê½  
 268   1        Sec_AT_Command("AT+CPMS=\"SM\",\"SM\",\"SM\"","OK",3);  //ËùÓÐ²Ù×÷¶¼ÔÚSIM¿¨ÖÐ½øÐÐ 
 269   1      //  strcat(temp,SMS_Num);
 270   1      //  Sec_AT_Command(temp,"OK",3);                            //ÉèÖÃ¶ÌÐÅÖÐÐÄºÅÂë
 271   1      }
 272          
 273          /*******************************************************************************
 274          * º¯ÊýÃû : Check_Message_rec
 275          * ÃèÊö   : ¼ì²éÊÇ·ñÓÐÐÂÐÅÏ¢£¬²¢Ö´ÐÐÐÅÏ¢ÄÚÈÝÖ¸Áî
 276          * ÊäÈë   : 
 277          * Êä³ö   : 
 278          * ·µ»Ø   : 
 279          * ×¢Òâ   : 
 280          *******************************************************************************/
 281          
 282          void Check_New_Message(void)
 283          {
 284   1        u8 temp=0,i;
 285   1        if(strstr(Uart2_Buf,"+CMT")!=NULL)      //Èô»º´æ×Ö·û´®ÖÐº¬ÓÐ"+CMT"¾Í±íÊ¾ÓÐÐÂµÄ¶ÌÐÅ
 286   1        {
 287   2          delay_ms(50);//µÈ´ýÊý¾ÝÈ«²¿½ÓÊÕÍê³É
 288   2          UART1_SendString("ÊÕµ½ÐÂ¶ÌÐÅ:\r\n");
 289   2          UART1_SendString(Uart2_Buf);      //°ÑÄ£¿é·µ»ØµÄÐÅÏ¢Ô­ÑùÊä³ö
 290   2          if(strstr(Uart2_Buf,Password)!=NULL)
 291   2          {
 292   3            if(strstr(Uart2_Buf,"Switch1:on")!=NULL)
 293   3            {
 294   4              UART1_SendString("ÊÕµ½ÐÂ¶ÌÐÅ:Switch1:on\r\n");
 295   4              Delay_1 = 0;
 296   4            }
 297   3            if(strstr(Uart2_Buf,"Switch1:off")!=NULL)
 298   3            {
 299   4              UART1_SendString("ÊÕµ½ÐÂ¶ÌÐÅ:Switch1:off\r\n");
 300   4              Delay_1 = 1;
 301   4            }
 302   3            if(strstr(Uart2_Buf,"Switch2:on")!=NULL)
C51 COMPILER V9.59.0.0   MAIN                                                              12/24/2018 14:09:35 PAGE 6   

 303   3            {
 304   4              UART1_SendString("ÊÕµ½ÐÂ¶ÌÐÅ:Switch2:on\r\n");
 305   4              Delay_2 = 0;
 306   4            }
 307   3            if(strstr(Uart2_Buf,"Switch2:off")!=NULL)
 308   3            {
 309   4              UART1_SendString("ÊÕµ½ÐÂ¶ÌÐÅ:Switch2:off\r\n");
 310   4              Delay_2 = 1;
 311   4            }
 312   3            if(strstr(Uart2_Buf,"Check")!=NULL)
 313   3            {
 314   4              UART1_SendString("ÊÕµ½ÐÂ¶ÌÐÅ:Check\r\n");
 315   4              UART1_SendString(&Uart2_Buf[12]);
 316   4              for(i=0;i<11;i++)
 317   4                  phone[1+i] = Uart2_Buf[12+i];
 318   4              Send_Text_Sms();
 319   4            }
 320   3            if(strstr(Uart2_Buf,"Alter")!=NULL)
 321   3            {
 322   4              UART1_SendString("ÊÕµ½ÐÂ¶ÌÐÅ:Alter\r\n");
 323   4              UART1_SendString(&Uart2_Buf[First_Int-6]);
 324   4              Password[0] = Uart2_Buf[First_Int-6];
 325   4              Password[1] = Uart2_Buf[First_Int-5];
 326   4              Password[2] = Uart2_Buf[First_Int-4];
 327   4              Password[3] = Uart2_Buf[First_Int-3];
 328   4              UART1_SendString(Password);
 329   4              UART1_SendString("ÐÂÃÜÂë\r\n");
 330   4            }
 331   3          }
 332   2          CLR_Buf2();
 333   2          Sec_AT_Command("AT+CMGD=1,1","OK",3);//É¾³ý¶ÌÐÅ
 334   2        }
 335   1      }
 336          
 337          /*******************************************************************************
 338          * º¯ÊýÃû : Wait_CREG
 339          * ÃèÊö   : µÈ´ýÄ£¿é×¢²á³É¹¦
 340          * ÊäÈë   : 
 341          * Êä³ö   : 
 342          * ·µ»Ø   : 
 343          * ×¢Òâ   : 
 344          *******************************************************************************/
 345          void Wait_CREG(void)
 346          {
 347   1        u8 i;
 348   1        u8 k;
 349   1        i = 0;
 350   1        CLR_Buf2();
 351   1        while(i == 0)             
 352   1        {
 353   2          CLR_Buf2();        
 354   2          UART2_SendString("AT+CREG?");
 355   2          UART2_SendLR();
 356   2          delay_ms(5000);             
 357   2            for(k=0;k<Buf2_Max;k++)           
 358   2            {
 359   3            if(Uart2_Buf[k] == ':')
 360   3            {
 361   4              if((Uart2_Buf[k+4] == '1')||(Uart2_Buf[k+4] == '5'))
 362   4              {
 363   5                i = 1;
 364   5                UART1_SendLR();
C51 COMPILER V9.59.0.0   MAIN                                                              12/24/2018 14:09:35 PAGE 7   

 365   5                break;
 366   5              }
 367   4            }
 368   3          }
 369   2          UART1_SendString("×¢²áÖÐ.....");
 370   2        }
 371   1      }
 372          
 373          void Send_Text_Sms(void)
 374          {
 375   1        unsigned char temp[50]="AT+CMGS=";
 376   1        Temp_Change(Ds18b20ReadTemp(),Datas_Buff);
 377   1        strcat(temp,phone); 
 378   1        Sec_AT_Command(temp,">",3); 
 379   1        UART2_SendString(content); 
 380   1        UART2_SendString(Datas_Buff); 
 381   1        UART2_SendData(0X1A); 
 382   1        UART2_SendLR(); 
 383   1      }
 384          
 385          void Temp_Change(int temp,unsigned char* Buff)
 386          {
 387   1          float tp;  
 388   1          if(temp< 0)       //µ±ÎÂ¶ÈÖµÎª¸ºÊý
 389   1          {
 390   2            Buff[0] = '-';
 391   2          //ÒòÎª¶ÁÈ¡µÄÎÂ¶ÈÊÇÊµ¼ÊÎÂ¶ÈµÄ²¹Âë£¬ËùÒÔ¼õ1£¬ÔÙÈ¡·´Çó³öÔ­Âë
 392   2          temp=temp-1;
 393   2          temp=~temp;
 394   2          tp=temp;
 395   2          temp=tp*0.0625*100+0.5; 
 396   2          //ÁôÁ½¸öÐ¡Êýµã¾Í*100£¬+0.5ÊÇËÄÉáÎåÈë£¬ÒòÎªCÓïÑÔ¸¡µãÊý×ª»»ÎªÕûÐÍµÄÊ±ºò°ÑÐ¡Êýµã
 397   2          //ºóÃæµÄÊý×Ô¶¯È¥µô£¬²»¹ÜÊÇ·ñ´óÓÚ0.5£¬¶ø+0.5Ö®ºó´óÓÚ0.5µÄ¾ÍÊÇ½ø1ÁË£¬Ð¡ÓÚ0.5µÄ¾Í
 398   2          //ËãÓÉÏ0.5£¬»¹ÊÇÔÚÐ¡ÊýµãºóÃæ¡£
 399   2          }
 400   1        else
 401   1          { 
 402   2          Buff[0] = '+';      
 403   2          tp=temp;//ÒòÎªÊý¾Ý´¦ÀíÓÐÐ¡ÊýµãËùÒÔ½«ÎÂ¶È¸³¸øÒ»¸ö¸¡µãÐÍ±äÁ¿
 404   2          //Èç¹ûÎÂ¶ÈÊÇÕýµÄÄÇÃ´£¬ÄÇÃ´ÕýÊýµÄÔ­Âë¾ÍÊÇ²¹ÂëËü±¾Éí
 405   2          temp=tp*0.0625*100+0.5; 
 406   2          //ÁôÁ½¸öÐ¡Êýµã¾Í*100£¬+0.5ÊÇËÄÉáÎåÈë£¬ÒòÎªCÓïÑÔ¸¡µãÊý×ª»»ÎªÕûÐÍµÄÊ±ºò°ÑÐ¡Êýµã
 407   2          //ºóÃæµÄÊý×Ô¶¯È¥µô£¬²»¹ÜÊÇ·ñ´óÓÚ0.5£¬¶ø+0.5Ö®ºó´óÓÚ0.5µÄ¾ÍÊÇ½ø1ÁË£¬Ð¡ÓÚ0.5µÄ¾Í
 408   2          //Ëã¼ÓÉÏ0.5£¬»¹ÊÇÔÚÐ¡ÊýµãºóÃæ¡£
 409   2          }
 410   1        Buff[1] = temp / 10000 + 0x30;
 411   1        Buff[2] = temp % 10000 / 1000 + 0x30;
 412   1        Buff[3] = temp % 1000 / 100 + 0x30;
 413   1        Buff[4] = '.';  
 414   1        Buff[5] = temp % 100 / 10 + 0x30;
 415   1        Buff[6] = temp % 10 + 0x30;
 416   1      }
 417          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1428    ----
   CONSTANT SIZE    =    523    ----
   XDATA SIZE       =    274    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     23      76
   IDATA SIZE       =   ----    ----
C51 COMPILER V9.59.0.0   MAIN                                                              12/24/2018 14:09:35 PAGE 8   

   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
